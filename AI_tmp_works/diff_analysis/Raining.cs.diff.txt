Change Type: significant_change
ILSpy: g:\unity\OnoCoro2026\Assets\Recovery\.Editor\ILspy_CS\Raining.cs
Scripts: g:\unity\OnoCoro2026\Assets\Scripts\GameEvents\Raining.cs
================================================================================

--- Raining.cs+++ Raining.cs@@ -1,92 +1,139 @@-// Assembly-CSharp, Version=0.0.0.0, Culture=neutral, PublicKeyToken=null
-// Raining
+using UnityEngine;
+using PlateauToolkit.Rendering;
+using System.Linq;
 using CommonsUtility;
-using UnityEngine;
 
+// using Microsoft.Win32.SafeHandles;
+// using System.Numerics; // PlateauToolkit.Rendering  Environment を利用のために追加
+
+// downpour 土砂降り
 public class Raining : MonoBehaviour
 {
-	private bool _is_rain;
+    // TODO: ステージ内で一意の状態であるようにする
+    private bool _is_rain = false; 
 
-	private float _time;
+    private const float RAINY_STRENGTH = 0.65f;    // 雨の強さ
+    private const float RAINY_CLOUD_STRENGTH = 0.75f;    // 雨のときの雲の強さ
+    private const float SUNNY_CLOUD_STRENGTH = 0.25f;    // 晴れのときの雲の強さ
+    private const float RAINY_FOG_STRENGTH = 200f;   // 雨のときの霧の強さ
+    // private const float RAINY_FOG_STRENGTH = 40f;   // 雨のときの霧の強さ
+    private const float SUNNY_FOG_STRENGTH = 500f;
+    private const float INTERVAL_RAIN = 0.01f;  // 雨粒が落ちてくる間隔
+    // private const float INTERVAL_RAIN = 0.05f;  // 雨粒が落ちてくる間隔
+    // private const float INTERVAL_RAIN = 1.00f;  // 雨粒が落ちてくる間隔
+    private float _time = 0.0f;
+    private GameObject _rain_holder = null;
 
-	private GameObject _eventSystem;
 
-	private static GameObject _parent_holder;
+    internal void ToggleRain()
+    {
+        EnvironmentController env = GameObject.Find("Environment").GetComponent<EnvironmentController>();
 
-	private const string _RAIN_PARENT_NAME = "Rains";
+        if (env.m_Rain > 0.0f)
+        {
+            env.m_Rain = 0.0f;
+            env.m_Cloud = SUNNY_CLOUD_STRENGTH;
+            env.m_FogDistance = SUNNY_FOG_STRENGTH;
+            _is_rain = false;
+            DeleteAllRain();
+            DeleteAllPuddle();
+        }
+        else
+        {
+            env.m_Rain = RAINY_STRENGTH;
+            env.m_Cloud = RAINY_CLOUD_STRENGTH;
+            env.m_FogDistance = RAINY_FOG_STRENGTH;
+            _is_rain = true;
+        }
 
-	internal const float INTERVAL_RAIN = 0.02f;
+    }
 
-	internal const float ABOVE_POSITION = 280f;
+    private void DeleteAllRain()
+    {
+        GameObject[] rainDrops = GameObject.FindGameObjectsWithTag(GameEnum.TagType.RainDrop.ToString());
+        foreach (GameObject rainDrop in rainDrops)
+        {
+            GameObjectTreat.DestroyAll(rainDrop);
+        }
+    }
 
-	internal void SetRainMode(bool isRain)
-	{
-		if (isRain)
-		{
-			_is_rain = true;
-			return;
-		}
-		_is_rain = false;
-		DeleteAllRain();
-		DeleteAllPuddle();
-	}
+    private void DeleteAllPuddle()
+    {
+        GameObject[] puddles = GameObject.FindGameObjectsWithTag(GameEnum.TagType.Puddle.ToString());
+        foreach (GameObject puddle in puddles)
+        {
+            GameObjectTreat.DestroyAll(puddle);
+        }
+    }
 
-	private void DeleteAllRain()
-	{
-		GameObject[] array = GameObject.FindGameObjectsWithTag(GameEnum.TagType.RainDrop.ToString());
-		for (int i = 0; i < array.Length; i++)
-		{
-			GameObjectTreat.DestroyAll(array[i]);
-		}
-	}
+    private void RainDrops()
+    {
+		GameObject prefab = Resources.Load<GameObject>("Prefabs/WorkUnit/RainDrop");
+        // prefab.transform.localScale = GetRandomSize(_LitterSizeMin, _LitterSizeMax);
+        // Vector3 setPoint = this.transform.position;
+        Vector3 setPoint = DemCtrl.GetDemRndAbovePosition(50f);
+        // Vector3 setPoint = new UnityEngine.Vector3(-251, 48, -71);
 
-	private void DeleteAllPuddle()
-	{
-		GameObject[] array = GameObject.FindGameObjectsWithTag(GameEnum.TagType.Puddle.ToString());
-		for (int i = 0; i < array.Length; i++)
-		{
-			GameObjectTreat.DestroyAll(array[i]);
-		}
-	}
+        // Quaternion setRotation = Quaternion.Euler(rdNum(0,360), rdNum(0,360), rdNum(0,360));
+        Quaternion setRotation = Quaternion.Euler(0, 0, 0);
+        GameObject unit = Instantiate(prefab, setPoint, setRotation);
+        unit.tag = GameEnum.TagType.RainDrop.ToString();
+        unit.name = GameEnum.TagType.RainDrop.ToString() + Time.time.ToString();
 
-	private void RainDrops()
-	{
-		GameObject rainDropPrefab = PrefabManager.RainDropPrefab;
-		Vector3 demRndAbovePosition = DemCtrl.GetDemRndAbovePosition(280f);
-		Quaternion rotation = Quaternion.Euler(0f, 0f, 0f);
-		GameObject obj = Object.Instantiate(rainDropPrefab, demRndAbovePosition, rotation);
-		obj.tag = GameEnum.TagType.RainDrop.ToString();
-		obj.name = GameEnum.TagType.RainDrop.ToString() + Time.time;
-		Transform holderParentTransform = GameObjectTreat.GetHolderParentTransform(ref _parent_holder, "Rains");
-		obj.transform.SetParent(holderParentTransform);
-	}
+        // Rigidbody rigidbody = unit.GetComponent<Rigidbody>();
+        // rigidbody.useGravity = true;
+        // Rigidbody rb        = GetComponent<Rigidbody>();
+        // Rigidbody rigidbody = unit.AddComponent<Rigidbody>();
+        // rigidbody.AddForce(transform.forward * _LitteringPow);
 
-	internal void OnTriggerEnter(Collider other)
-	{
-		if (other.gameObject.tag == GameEnum.UnitType.Player.ToString())
-		{
-			_eventSystem = GameObjectTreat.GetEventSystem(_eventSystem);
-			WeatherCtrl orAddComponent = GameObjectTreat.GetOrAddComponent<WeatherCtrl>(_eventSystem);
-			float toggleRainStrength = orAddComponent.GetToggleRainStrength();
-			orAddComponent.ChangeWeather(toggleRainStrength);
-		}
-	}
+        unit.transform.SetParent(GetRainHolder().transform);
+    }
 
-	private void Awake()
-	{
-	}
+    private GameObject GetRainHolder()
+    {
+        if (_rain_holder == null)
+        {
+            _rain_holder = GameObject.Find("rains");
+            if (_rain_holder == null)
+            {
+                // gameObject rains を追加する
+                _rain_holder = new GameObject("rains");
+            }
+        }
+        return _rain_holder;
+    }
 
-	private void Update()
-	{
-		if (_is_rain)
-		{
-			float num = 0.02f / GameSpeedCtrl.GetGameSpeed();
-			_time += Time.deltaTime;
-			if (_time > num)
-			{
-				_time = 0f;
-				RainDrops();
-			}
-		}
-	}
+
+    internal void OnTriggerEnter(Collider other)
+    {
+
+        if (other.gameObject.tag == GameEnum.UnitType.Player.ToString())
+        {
+            // Debug.Log("OnTriggerEnter " + other.name + " object:" + other.gameObject.name);
+            ToggleRain();
+            return;
+        }
+    }
+
+    void Awake()
+    {
+        // _rain = GameObject.Find("Environment/Rain").gameObject;
+    }
+
+    void Update()
+    {
+        if (!_is_rain)
+        {
+            return;
+        }
+
+        _time += Time.deltaTime;
+        if (_time > INTERVAL_RAIN)
+        {
+            _time = 0.0f;
+            RainDrops();
+        }
+
+    }
+
 }


================================================================================
Significant Changes: 162
-	private bool _is_rain;

+    private bool _is_rain = false; 

-	private float _time;

+    private const float RAINY_STRENGTH = 0.65f;    // 雨の強さ

+    private const float RAINY_CLOUD_STRENGTH = 0.75f;    // 雨のときの雲の強さ

+    private const float SUNNY_CLOUD_STRENGTH = 0.25f;    // 晴れのときの雲の強さ

+    private const float RAINY_FOG_STRENGTH = 200f;   // 雨のときの霧の強さ

+    private const float SUNNY_FOG_STRENGTH = 500f;

+    private const float INTERVAL_RAIN = 0.01f;  // 雨粒が落ちてくる間隔

+    private float _time = 0.0f;

+    private GameObject _rain_holder = null;

-	private GameObject _eventSystem;

-	private static GameObject _parent_holder;

+    internal void ToggleRain()

+    {

+        EnvironmentController env = GameObject.Find("Environment").GetComponent<EnvironmentController>();

-	private const string _RAIN_PARENT_NAME = "Rains";

+        if (env.m_Rain > 0.0f)

+        {

+            env.m_Rain = 0.0f;

