Change Type: significant_change
ILSpy: g:\unity\OnoCoro2026\Assets\Recovery\.Editor\ILspy_CS\StagingYamlCtrl.cs
Scripts: g:\unity\OnoCoro2026\Assets\Scripts\Utility\StagingYamlCtrl.cs
================================================================================

--- StagingYamlCtrl.cs+++ StagingYamlCtrl.cs@@ -1,295 +1,308 @@-// Assembly-CSharp, Version=0.0.0.0, Culture=neutral, PublicKeyToken=null
-// StagingYamlCtrl
 using System;
+using System.IO;
+using System.Collections;
 using System.Collections.Generic;
-using System.IO;
+using UnityEngine;
+// using UnityYamlData;
+// using YamlDotNet.Serialization;
+using YamlDotNet.RepresentationModel;
+using System.Net.Http.Headers;
+using UnityEngine.AI;
+using Unity.VisualScripting;
 using CommonsUtility;
-using UnityEngine;
-using UnityEngine.SceneManagement;
-using YamlDotNet.RepresentationModel;
 
 public class StagingYamlCtrl : MonoBehaviour
 {
-	private const string _YAML_FOLDER_PATH = "Assets/StreamingAssets/staging/";
-
-	private EventLoader _eventLoader;
-
-	public static List<string> _ItemList = new List<string>();
-
-	internal void LoadYamlData(string stageName)
-	{
-		YamlStream yamlStream = LoadStreamingAsset.LoadYamlFile(Path.GetFileName(stageName + ".yaml"));
-		if (yamlStream == null)
-		{
-			Debug.Log("yaml is null");
-			return;
-		}
-		ActionStageNotice(yamlStream);
-		SetTimerEventData(yamlStream);
-		SetStageInitData(yamlStream);
-		SetItemList(yamlStream);
-		SetPathMakerList(yamlStream);
-		SetGoalsRequirements(yamlStream);
-		SetGameOversRequirements(yamlStream);
-		SetBoardInitData(yamlStream);
-	}
-
-	private void SetGoalsRequirements(YamlStream yaml)
-	{
-		YamlSequenceNode yamlSequenceNode = GetYamlSequenceNode(yaml, "goals");
-		Dictionary<string, string> dictionary = new Dictionary<string, string>();
-		if (yamlSequenceNode == null)
-		{
-			return;
-		}
-		foreach (YamlMappingNode item in yamlSequenceNode)
-		{
-			foreach (KeyValuePair<YamlNode, YamlNode> child in item.Children)
-			{
-				dictionary.Add(((YamlScalarNode)child.Key).Value, ((YamlScalarNode)child.Value).Value);
-				Debug.Log(((YamlScalarNode)child.Key).Value + " : " + ((YamlScalarNode)child.Value).Value);
-			}
-		}
-		if (dictionary.Count > 0)
-		{
-			StageGoalCtrl._dict_req = dictionary;
-			StageGoalCtrl.StartCheckStageGoal(this);
-		}
-	}
-
-	private void SetGameOversRequirements(YamlStream yaml)
-	{
-		YamlSequenceNode yamlSequenceNode = GetYamlSequenceNode(yaml, "gameovers");
-		Dictionary<string, string> dictionary = new Dictionary<string, string>();
-		if (yamlSequenceNode == null)
-		{
-			return;
-		}
-		foreach (YamlMappingNode item in yamlSequenceNode)
-		{
-			foreach (KeyValuePair<YamlNode, YamlNode> child in item.Children)
-			{
-				dictionary.Add(((YamlScalarNode)child.Key).Value, ((YamlScalarNode)child.Value).Value);
-				Debug.Log(((YamlScalarNode)child.Key).Value + " : " + ((YamlScalarNode)child.Value).Value);
-			}
-		}
-		if (dictionary.Count > 0)
-		{
-			StageGoalCtrl._dict_fail = dictionary;
-			StageGoalCtrl.StartCheckStageFail(this);
-		}
-	}
-
-	internal static List<string> GetItemList()
-	{
-		return _ItemList;
-	}
-
-	private void SetPathMakerList(YamlStream yaml)
-	{
-		YamlSequenceNode yamlSequenceNode = GetYamlSequenceNode(yaml, "pathmakers");
-		if (yamlSequenceNode == null)
-		{
-			return;
-		}
-		PathMakerCtrl.ResetPathMakerDict();
-		foreach (YamlMappingNode item in yamlSequenceNode)
-		{
-			string key = "";
-			Vector3 value = Vector3.zero;
-			foreach (KeyValuePair<YamlNode, YamlNode> child in item.Children)
-			{
-				string value2 = ((YamlScalarNode)child.Key).Value;
-				if (!string.IsNullOrEmpty(value2))
-				{
-					if (value2 == "name")
-					{
-						key = ((YamlScalarNode)child.Value).Value;
-						key = key.Trim();
-					}
-					if (value2 == "pos")
-					{
-						value = Utility.StringToVector3(((YamlScalarNode)child.Value).Value);
-					}
-					if (PathMakerCtrl._pathMakerDict.ContainsKey(key))
-					{
-						PathMakerCtrl._pathMakerDict[key] = value;
-					}
-					else
-					{
-						PathMakerCtrl._pathMakerDict.Add(key, value);
-					}
-				}
-			}
-		}
-		PathMakerCtrl.CreateGameObjectByPathMakerDict();
-	}
-
-	private void SetItemList(YamlStream yaml)
-	{
-		YamlSequenceNode yamlSequenceNode = GetYamlSequenceNode(yaml, "itemlists");
-		if (yamlSequenceNode == null)
-		{
-			return;
-		}
-		foreach (YamlMappingNode item in yamlSequenceNode)
-		{
-			foreach (KeyValuePair<YamlNode, YamlNode> child in item.Children)
-			{
-				string value = ((YamlScalarNode)child.Value).Value;
-				if (!string.IsNullOrEmpty(value) && !_ItemList.Contains(value))
-				{
-					if (!Enum.IsDefined(typeof(GameEnum.ModelsType), value))
-					{
-						Debug.Log("itemname " + value + " は GameEnum.ModelsType に定義されていません");
-					}
-					else
-					{
-						_ItemList.Add(value);
-					}
-				}
-			}
-		}
-	}
-
-	private void ActionStageNotice(YamlStream yaml)
-	{
-		foreach (KeyValuePair<YamlNode, YamlNode> child in ((YamlMappingNode)yaml.Documents[0].RootNode).Children)
-		{
-			if (object.Equals((YamlScalarNode)child.Key, new YamlScalarNode("stagenotice")))
-			{
-				GameObject.Find("UINotice").GetComponent<NoticeCtrl>().ShowNotice(((YamlScalarNode)child.Value).Value);
-				break;
-			}
-		}
-	}
-
-	private void SetStageInitData(YamlStream yaml)
-	{
-		YamlSequenceNode yamlSequenceNode = GetYamlSequenceNode(yaml, "stages");
-		if (yamlSequenceNode == null)
-		{
-			return;
-		}
-		foreach (YamlMappingNode item in yamlSequenceNode)
-		{
-			foreach (KeyValuePair<YamlNode, YamlNode> child in item.Children)
-			{
-				if (!TrySetScore("BIT", ((YamlScalarNode)child.Key).Value, ((YamlScalarNode)child.Value).Value))
-				{
-					TrySetScore("CLK", ((YamlScalarNode)child.Key).Value, ((YamlScalarNode)child.Value).Value);
-				}
-			}
-		}
-	}
-
-	private void SetBoardInitData(YamlStream yaml)
-	{
-		YamlSequenceNode yamlSequenceNode = GetYamlSequenceNode(yaml, "boards");
-		if (yamlSequenceNode == null)
-		{
-			return;
-		}
-		Dictionary<string, string> dictionary = new Dictionary<string, string>();
-		foreach (YamlMappingNode item in yamlSequenceNode)
-		{
-			string key = "";
-			foreach (KeyValuePair<YamlNode, YamlNode> child in item.Children)
-			{
-				if (((YamlScalarNode)child.Key).Value == "code")
-				{
-					key = ((YamlScalarNode)child.Value).Value;
-				}
-				else
-				{
-					dictionary.Add(key, ((YamlScalarNode)child.Value).Value);
-				}
-			}
-		}
-		if (dictionary.Count > 0)
-		{
-			_eventLoader._board_data = new Dictionary<string, string>(dictionary);
-		}
-	}
-
-	private bool TrySetScore(string scoretype, string key, string val)
-	{
-		if (scoretype == key && int.TryParse(val, out var result))
-		{
-			ScoreCtrl.InitScore(result, key);
-		}
-		return false;
-	}
-
-	private YamlSequenceNode GetYamlSequenceNode(YamlStream yaml, string key)
-	{
-		YamlMappingNode yamlMappingNode = (YamlMappingNode)yaml.Documents[0].RootNode;
-		YamlScalarNode key2 = new YamlScalarNode(key);
-		if (!yamlMappingNode.Children.ContainsKey(key2))
-		{
-			return null;
-		}
-		YamlNode yamlNode = yamlMappingNode.Children[key2];
-		if (!(yamlNode is YamlSequenceNode))
-		{
-			return null;
-		}
-		return (YamlSequenceNode)yamlNode;
-	}
-
-	private void SetTimerEventData(YamlStream yaml)
-	{
-		YamlSequenceNode yamlSequenceNode = GetYamlSequenceNode(yaml, "events");
-		if (yamlSequenceNode == null)
-		{
-			return;
-		}
-		foreach (YamlMappingNode item in yamlSequenceNode)
-		{
-			float num = -1f;
-			Dictionary<string, string> dictionary = new Dictionary<string, string>();
-			foreach (KeyValuePair<YamlNode, YamlNode> child in item.Children)
-			{
-				if (((YamlScalarNode)child.Key).Value == "time")
-				{
-					num = float.Parse(((YamlScalarNode)child.Value).Value);
-				}
-				else
-				{
-					dictionary.Add(((YamlScalarNode)child.Key).Value, ((YamlScalarNode)child.Value).Value);
-				}
-			}
-			if (!(num >= 0f))
-			{
-				continue;
-			}
-			List<Dictionary<string, string>> value;
-			if (_eventLoader._timer_events.ContainsKey(num))
-			{
-				_eventLoader._timer_events.TryGetValue(num, out value);
-				if (value == null)
-				{
-					Debug.Log("event_list is null ");
-					value = new List<Dictionary<string, string>>();
-				}
-				value.Add(dictionary);
-				_eventLoader._timer_events[num] = value;
-			}
-			else
-			{
-				value = new List<Dictionary<string, string>>();
-				value.Add(dictionary);
-				_eventLoader._timer_events.Add(num, value);
-			}
-		}
-		_eventLoader.SetEventToTimer();
-	}
-
-	private void Awake()
-	{
-		_eventLoader = base.transform.parent.gameObject.AddComponent<EventLoader>();
-		string text = SceneManager.GetActiveScene().name;
-		Debug.Log("StagingYamlCtrl sceneName " + text);
-		LoadYamlData(text);
-	}
+    // YamlDotNet for Unity
+    // https://assetstore.unity.com/packages/tools/integration/yamldotnet-for-unity-36292
+    // Git hub YamlDotNet
+    // https://github.com/aaubry/YamlDotNet
+
+
+    // const string ex_yamlPath = "Assets/Resources/staging/ex.yaml";
+    // const string yamlPath = "staging/ex.yaml";
+    const string _YAML_FOLDER_PATH = "Assets/Resources/staging/";
+
+    // イベントローダー
+    private EventLoader _eventLoader = null;
+    // public List<ItemStruct> _yamlItemList = new List<ItemStruct>();
+    public static List<string> _ItemList = new List<string>();
+
+    internal void LoadYamlData(string stageName)
+    {
+        var input = new StreamReader(_YAML_FOLDER_PATH + stageName + ".yaml");
+        TextReader textReader = new StringReader(input.ReadToEnd());
+        if (textReader == null)
+        {
+            return;
+        }
+
+        var yaml = new YamlStream();
+        yaml.Load(textReader);
+        if (yaml.Documents.Count == 0)
+        {
+            return;
+        }
+
+        ActionStageNotice(yaml);
+        SetTimerEventData(yaml);
+        SetStageInitData(yaml);
+        SetItemList(yaml);
+        SetGoalsRequirements(yaml);
+        SetBoardInitData(yaml);
+    }
+
+    private void SetGoalsRequirements(YamlStream yaml)
+    {
+        YamlSequenceNode YSeqNode = GetYamlSequenceNode(yaml, "goals");
+        Dictionary<string, string> goals_req = new Dictionary<string, string>();
+        if (YSeqNode == null)
+        {
+            return;
+        }
+
+        foreach (YamlMappingNode yamlevent in YSeqNode)
+        {
+            foreach (var entry in yamlevent.Children)
+            {
+                // string req = ((YamlScalarNode)entry.Value).Value;
+                // if (string.IsNullOrEmpty(req))
+                // {
+                //     continue;
+                // }
+                goals_req.Add(
+                    ((YamlScalarNode)entry.Key).Value
+                    , ((YamlScalarNode)entry.Value).Value
+                );
+                // StageGoalCtrl._GoalsRequirementsList.Add(req);
+                Debug.Log(((YamlScalarNode)entry.Key).Value + " : " + ((YamlScalarNode)entry.Value).Value);
+            }
+        }
+        if (goals_req.Count > 0)
+        {
+            StageGoalCtrl._dict_req = goals_req;
+        }
+    }
+
+    internal static List<string> GetItemList()
+    {
+        return _ItemList;
+    }
+
+    private void SetItemList(YamlStream yaml)
+    {
+        YamlSequenceNode YSeqNode = GetYamlSequenceNode(yaml, "itemlists");
+        if (YSeqNode == null)
+        {
+            return;
+        }
+
+        foreach (YamlMappingNode yamlevent in YSeqNode)
+        {
+            foreach (var entry in yamlevent.Children)
+            {
+                // Debug.Log(((YamlScalarNode)entry.Value).Value);
+                string itemname = ((YamlScalarNode)entry.Value).Value;
+                if (string.IsNullOrEmpty(itemname))
+                {
+                    continue;
+                }
+
+                // _ItemListにすでに格納されているか確認
+                if (_ItemList.Contains(itemname))
+                {
+                    continue;
+                }
+
+                // itemname が GameEnum.ModelsType に定義されているか確認
+                if (!Enum.IsDefined(typeof(GameEnum.ModelsType), itemname))
+                {
+                    Debug.Log("itemname " + itemname + " は GameEnum.ModelsType に定義されていません");
+                    continue;
+                }
+                _ItemList.Add(itemname);
+            }
+        }
+    }
+
+    private void ActionStageNotice(YamlStream yaml)
+    {
+        var mapping = (YamlMappingNode)yaml.Documents[0].RootNode;
+        foreach (var entry in mapping.Children)
+        {
+            if (YamlScalarNode.Equals((YamlScalarNode)entry.Key, new YamlScalarNode("stagenotice")))
+            {
+                GameObject UINotice = GameObject.Find("UINotice");
+                UINotice.GetComponent<NoticeCtrl>().ShowNotice(((YamlScalarNode)entry.Value).Value);
+                return;
+            }
+        }
+    }
+
+    private void SetStageInitData(YamlStream yaml)
+    {
+        YamlSequenceNode YSeqNode = GetYamlSequenceNode(yaml, "stages");
+        if (YSeqNode == null)
+        {
+            return;
+        }
+
+        foreach (YamlMappingNode yamlevent in YSeqNode)
+        {
+            // Dictionary<string, string> staging_data = new Dictionary<string, string>();
+            foreach (var entry in yamlevent.Children)
+            {
+                // Debug.Log(((YamlScalarNode)entry.Key).Value + " : " + ((YamlScalarNode)entry.Value).Value);
+                if (TrySetScore(GlobalConst.SHORT_SCORE1_SCALE, ((YamlScalarNode)entry.Key).Value, ((YamlScalarNode)entry.Value).Value))
+                {
+                    continue;
+                }
+                if (TrySetScore(GlobalConst.SHORT_SCORE2_SCALE, ((YamlScalarNode)entry.Key).Value, ((YamlScalarNode)entry.Value).Value))
+                {
+                    continue;
+                }
+            }
+        }
+    }
+
+
+    private void SetBoardInitData(YamlStream yaml)
+    {
+        YamlSequenceNode YSeqNode = GetYamlSequenceNode(yaml, "boards");
+        if (YSeqNode == null)
+        {
+            return;
+        }
+
+        Dictionary<string, string> board_data = new Dictionary<string, string>();
+        foreach (YamlMappingNode yamlevent in YSeqNode)
+        {
+            String board_code = "";
+            // float event_time = -1f;
+            foreach (var entry in yamlevent.Children)
+            {
+                if (((YamlScalarNode)entry.Key).Value == "code")
+                {
+                    board_code = ((YamlScalarNode)entry.Value).Value;
+                    continue;
+                }
+                board_data.Add(board_code, ((YamlScalarNode)entry.Value).Value);
+            }
+
+        }
+        if (board_data.Count > 0)
+        {
+            // foreach (var item in board_data)
+            // {
+            //     Debug.Log($"{item.Key}={item.Value}");
+            // }
+            // Debug.Log("board_data.Count " + board_data);
+            // Debug.Log("_eventLoader.Count " + _eventLoader );
+            // Debug.Log("_eventLoader._board_data.Count " + _eventLoader._board_data.Count );
+
+            _eventLoader._board_data = new Dictionary<string, string>(board_data);
+        }
+        _eventLoader.InitBoardData();
+    }
+
+
+    private bool TrySetScore(string scoretype, string key, string val)
+    {
+        if (scoretype == key)
+        {
+            if (int.TryParse(val, out int intVal))
+            {
+                ScoreCtrl.InitScore(intVal, key);
+            }
+        }
+        return false;
+    }
+
+
+    private YamlSequenceNode GetYamlSequenceNode(YamlStream yaml, string key)
+    {
+        var mapping = (YamlMappingNode)yaml.Documents[0].RootNode;
+        YamlScalarNode YSNode = new YamlScalarNode(key);
+        if (!mapping.Children.ContainsKey(YSNode))
+        {
+            return null;
+        }
+        YamlNode YSeqNode = mapping.Children[YSNode];
+        if (!(YSeqNode is YamlSequenceNode))
+        {
+            return null;
+        }
+        return (YamlSequenceNode)YSeqNode;
+    }
+
+    private void SetTimerEventData(YamlStream yaml)
+    {
+        YamlSequenceNode YSeqNode = GetYamlSequenceNode(yaml, "events");
+        if (YSeqNode == null)
+        {
+            return;
+        }
+        foreach (YamlMappingNode yamlevent in YSeqNode)
+        {
+            float event_time = -1f;
+            Dictionary<string, string> event_data = new Dictionary<string, string>();
+            foreach (var entry in yamlevent.Children)
+            {
+                if (((YamlScalarNode)entry.Key).Value == "time")
+                {
+                    event_time = float.Parse(((YamlScalarNode)entry.Value).Value);
+                    continue;
+                }
+                event_data.Add(((YamlScalarNode)entry.Key).Value, ((YamlScalarNode)entry.Value).Value);
+            }
+            if (event_time >= 0f)
+            {
+                // List<Dictionary<string, string>> event_list = new List<Dictionary<string, string>>();
+                List<Dictionary<string, string>> event_list;
+                if (_eventLoader._timer_events.ContainsKey(event_time))
+                {
+                    _eventLoader._timer_events.TryGetValue(event_time, out event_list);
+                    if (event_list == null)
+                    {
+                        Debug.Log("event_list is null ");
+                        event_list = new List<Dictionary<string, string>>();
+                    }
+                    // Debug.Log("event_list " + event_list);
+
+                    event_list.Add(event_data);
+                    // _timer_events の event_time を event_list で 上書き
+                    _eventLoader._timer_events[event_time] = event_list;
+                }
+                else
+                {
+                    event_list = new List<Dictionary<string, string>>();
+                    event_list.Add(event_data);
+                    _eventLoader._timer_events.Add(event_time, event_list);
+                    // Debug.Log("event_list new add : " + event_list);
+
+                }
+            }
+        }
+        _eventLoader.SetEventToTimer();
+    }
+
+    void Awake()
+    {
+        // クラス名を表示する
+        // Debug.Log(this.GetType().FullName + " " + System.Reflection.MethodBase.GetCurrentMethod().Name);
+
+        // this.gameObject.AddComponent<EventLoader>();
+        _eventLoader = this.transform.parent.gameObject.AddComponent<EventLoader>();
+        // _eventLoader = this.gameObject.GetComponent<EventLoader>();
+        // _eventLoader = this.transform.parent.gameObject.GetComponent<EventLoader>();
+        // _eventLoader._events = new Dictionary<string, object[]>();
+
+        // 現在のシーン名を取得
+        string sceneName = UnityEngine.SceneManagement.SceneManager.GetActiveScene().name;
+        Debug.Log("StagingYamlCtrl sceneName "+sceneName);
+        LoadYamlData(sceneName);    // シーン名と同名のYamlデータを取得読み込み
+    }
+
+
+
 }


================================================================================
Significant Changes: 487
-	private const string _YAML_FOLDER_PATH = "Assets/StreamingAssets/staging/";

-	private EventLoader _eventLoader;

-	public static List<string> _ItemList = new List<string>();

-	internal void LoadYamlData(string stageName)

-	{

-		YamlStream yamlStream = LoadStreamingAsset.LoadYamlFile(Path.GetFileName(stageName + ".yaml"));

-		if (yamlStream == null)

-		{

-			Debug.Log("yaml is null");

-			return;

-		}

-		ActionStageNotice(yamlStream);

-		SetTimerEventData(yamlStream);

-		SetStageInitData(yamlStream);

-		SetItemList(yamlStream);

-		SetPathMakerList(yamlStream);

-		SetGoalsRequirements(yamlStream);

-		SetGameOversRequirements(yamlStream);

-		SetBoardInitData(yamlStream);

-	}

