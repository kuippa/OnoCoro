#154 2026/1/6
元旦からの裏作業で古いプロジェクトを順々にマージしつつ復活させていました。
最後のパッケージが８月で、それ以降はビルドで吐き出したバイナリしかなく失われてしまいました。
とはいえ、この寝ていた間にAIのエージェント機能やプランモードなどの進化が著しいため、やり方も大きく変わりそうです。
お正月から作業をはじめましたが、instructions.md なんかがあるところが以前とは違うところでしょうか。
重複しているファイルやコンパイルエラーが999+で出たのでこれを0にするところまでは裏作業でやりました。

Unityのsceneやprefabなどは失われてしまっているので、これらを作り直す必要があります。
つぎにリバースエンジニアリングで戻したコードがあるので、これを現バージョンに反映したいとおもいます。

Unityのバージョンを6.3.2f1に変更しました。その他、パッケージマネージャーでアップデートできるところは限界まであげています。シネマシーンが2系統から3になったのが大きな変更かもしれません。

タイトル画面あたりからのシーン別に復活をさせつつ、コア機能のクラスをリバースエンジニアで戻したコードからマージしようとおもいます。
とはいえ、このプロジェクトをみるのがもう８ヶ月ぶりなので、今日は現状把握で終わるとおもいます。

---

# 2026/1/6-7 作業内容

## ILSpyコードのマージとリファクタリング

### 1. ファイル構成の整理
- `stagelist.csv` を `StreamingAssets/public_doc/` に移動
- `TitleStartCtrl.cs` で参照パスを `"public_doc/stagelist.csv"` に更新
- `aboutthisgame.txt` を `StreamingAssets/staging/` に配置（Resources → StreamingAssetsに変更）

### 2. ILSpyコードのマージ
**GameObjectTreat.cs にメソッド追加:**
- `GetAppVersion()` - Application.versionを取得
- `GetAppBuildDate()` - ビルド日時を取得
- `GetGameManagerObject()` - GameManagerの取得または作成
- `GetEventSystem()` - EventSystemの取得または作成
- `GetGameObjectPath()` - GameObjectの階層パスを文字列で取得
- `GetOrAddComponent<T>()` - コンポーネントの取得または追加
- `GetHolderParentTransform()` - Holderタグ付き親トランスフォーム取得
- `GetParentTransform()` (オーバーロード) - 親トランスフォームの取得
- `GetOrNewGameObject()` - GameObjectの取得または新規作成

**GameEnum.cs に追加:**
- `TagType`: Holder, WaterTurret, DustBox, SentryGuard, PathBloom
- `ModelsType`: WaterTurret, DustBox, SentryGuard
- `LayerType`: AreaIgnoreRaycast

### 3. コーディング規約の策定
**instructions.md に以下を追加:**
1. **名前空間の衝突回避** - `using Debug = UnityEngine.Debug;` の使用義務化
2. **マジックナンバー・文字列の禁止** - すべての直値を定数化
3. **中括弧の必須化** - すべての制御文（if, else, for, while）で `{}` を使用
4. **三項演算子・null条件演算子の使用禁止** - 明示的な if-else と null チェック
5. **関数の行数制限** - 1関数40行以内、機能単位で分割
6. **定数の命名規則** - `_CONSTANT_NAME_FORMAT` (プライベート)
7. **コメント規約** - コードで意図を表現、コメントは最小限に

### 4. TitleStartCtrl.cs の大規模リファクタリング

**4.1 マジック値の定数化 (50+ constants)**
```csharp
// 定数グループ化
- File Constants (3項目)
- URL Constants (1項目)
- GameObject Names (14項目)
- GameObject Path Constants (4項目)
- Prefab Child Element Names (4項目)
- Instance Names (2項目)
- Editor Commands (4項目)
- UI Messages (14項目)
- Numeric Constants (4項目)
- Text Format Constants (1項目)
```

**4.2 Awake() メソッドの分割**
冗長な100行超のメソッドを6つの初期化関数に分割:
- `InitializeLoadingCanvas()` - ローディングキャンバス初期化
- `InitializePanels()` - 4つのパネル初期化
- `RegisterButtonListeners()` - 6つのボタンイベント登録
- `InitializeStageContents()` - ステージコンテンツとスクロールバー初期化
- `InitializeVersionInfo()` - バージョン情報初期化
- `CheckRuntimeObjects()` - 実行時オブジェクトの事前チェック
- `CheckMissingObjects()` - 不足オブジェクトのログ出力

**4.3 DRY原則の適用 (コード量73%削減)**
共通ヘルパーメソッドの導入:
- `FindAndSetupPanel()` - パネル検索・初期化
- `RegisterButton()` - ボタンイベント登録
- `FindAndInitialize()` - GameObject検索・初期化アクション実行

**効果:** 150行 → 40行に圧縮

**4.4 コーディング規約の適用**
- すべての if-else 文に中括弧 `{}` を追加
- null条件演算子 `?.` を明示的な null チェックに置き換え
- `using Debug = UnityEngine.Debug;` を追加
- `System.Diagnostics.Process` は完全修飾名で使用

### 5. 不足しているUIオブジェクトの特定
実行時チェック機能により16個の不足オブジェクトを特定:
```
基本UI:
- nowloading (Canvas)
- txtVersionInfo (TextMeshProUGUI)

ボタン (6個):
- btnGameClose, btnAboutGame, btnStageEditor
- btnStage, btnYamlEdit, btnBugReport

パネル構造 (4個 + 子要素):
- pnlStageSelector + Scroll View/Viewport/Content + Scrollbar Vertical
- pnlStageEditor + Scroll View/Viewport/Content + Scrollbar Vertical
- pnlAboutThisGame + tmpGameInfo
- pnlYAMLEditor + tmpInputField + txtYamlPath
```

## 次回作業予定
1. Unity エディタで上記16個のGameObjectを作成
2. UIレイアウトの調整
3. Prefabの作成 (UIStageSelector, UIStageFileList)
4. タイトル画面の動作確認

## ファイル移動
- `GameEnum.cs` → `done/` フォルダに移動（マージ完了）
- `CommonsUtility.GameObjectTreat.cs` → `done/` フォルダに移動（マージ完了）

---

このライブは、もくもくとマイクオフっての無音作業配信となります。

せこせこリリース準備をするためにビルドを繰り返していたところ話題のwindows11のSSD吹き飛ばしにあいました。作業記録はとってたのに世代バックアップ同じSSD内にあったので、ほぼロスト。2025/4を最後に心折れてましたが、2026/1になったので再起動します。

NASに落としていた2年前のバックアップと、他のマシンに移していたバイナリからのリバースコードで復元を目指します。お正月からから復元マージ作業していましたが、2024/8相当分ぐらいまでは戻せたのでここから公開作業にはいります。

さすがに懲りたのでGit入れるついでにオープンソースプロジェクトになりました。
https://github.com/kuippa/OnoCoro

#indiedev #madewithunity
