#1
2023/1/12 
荒い方針のメモ書きの作成
ExampleAssetsを触ってあれこれパラメータをいじってみる
現在、
Starter Assets - Third Person Character Controller
インポート中

#2
2023/1/14
スタートアセットのドキュメンテーションに従ったチュートリアルをおこった。
アニメにわりつけしての足音鳴らし。キーバインドの追加など。
かなり複雑なので、もう少しやらないとだめそう。
事前に参考資料などを見ておくことにする。

#3
2023/1/19
Starter Assets、ProBuilderをほんのすこしだけ触ってみる。わからん。
UniversalRenderingExamplesの新規プロジェクトを作成
スターターアセット以上に何をしていいかわからないし、コンポーネントの追加による挙動が不明。
これを使ったサンプルとかチュートリアル的なものがあるはずなので、それについて調べておく。
使えそうだったら次回もUniversalRenderingExamplesを触ってみて、ちょっと沼が深そうであればPLATEAU3に移動。
さわってみるな、お勉強の回でした。

#4
2023/1/26
UniversalRenderingExamplesのDEMOに触る。

NavMesh Agent
NavMeshAgent コンポーネントは、相互に回避しながら目的地点に向かって進行するキャラクターの作成に利用できます
https://docs.unity3d.com/ja/2021.2/Manual/class-NavMeshAgent.html
カメラシネマシーンを少し


#5 2023/1/31
Visual Effect Graphに触る

https://blog.unity.com/ja/technology/visual-effect-graph-samples

Visual Effect Graph - samples
https://github.com/Unity-Technologies/VisualEffectGraph-Samples/releases

Visual Effect Graph BonFire(焚き火エフェクト)
Meteorite、どこまでがVXF？


#6 2023/2/2
使えそうなVFXをひきつづき調査
02_Meteorite : 隕石 
04_GroundImpactAdds : 隕石爆発
Bonfire ： 焚き火
Environment_GrassWind ： 草混じりの風
FlyingLeaves ： 草混じりの風
FireEmbers ： 火花
FireSampling : 火と煙
Flames ： 立ち上がる炎
Smoke ： （同名で２つ）煙
Trails ： 飛び経つ なにか
WaterSampling ： 水面の波紋
TreeやGrassのような環境物も
Portal(火花が回る系エフェクト)
Arurk-table-PinScreen ：イントロの地球に隕石などが降って滅びる系のシーンとかに
Volumetric : 撒き散らしながらうねうねするやつ
VoxelizedTerrain : 仮想地形


#7 2023/2/8
国土交通省 Plateau
フランス語 高い平原
https:///www.youtube.com/watch?v=YowtHclv6j4
youtubeを見ながら対応

23区のデータをFBXでダウンロード
2.8GB
https://www.geospatial.jp/ckan/dataset/plateau-tokyo23ku


スケールファクターを１から１００に
もしくはオブジェクトを１から１００に

地面とビルディングをグループ化したうえで
原点に対象物をもってくる
Alt+Ctrl+[F]

カメラにfree cameraを追加

lod2のモデルデータ、70MB超えるあたりから、インポートが指数関数的に時間がかかるようになる。
260MBは30分待ったが戻ってこず。


Fbx、Mayaのデータ形式で骨格リグもっている。


https://qiita.com/jhorikawa_err/items/a8562b5d38bb6ae3edea
環境によってはテクスチャがインポートされてない場合があります。その時はメッシュアセットのMaterialsタブにいって、Extract Texturesボタンを押して、好きなフォルダにテクスチャを書き出します。そうすると自動でメッシュにテクスチャが貼り付けられます。


Simplygon
3Dモデルを結合してドローコール数を減らす


Plateau 別々の細かいデータ
https://www.geospatial.jp/ckan/dataset/plateau-tokyo23ku-fbx-2020

LOD3には外観データもある

> PLATEAUのテクスチャ､数千枚のtifは重すぎ…
> なので変換した。
> 以下の方法でjpgへの一括変更出来たです。
> 
> ・Ralphaでtif→jpg変換
> ※Bridgeは時間かかりすぎた Ralpha爆速
> 
> ・Cinema4Dのアセットマネージャで一括パス変換


Ralpha
https://forest.watch.impress.co.jp/library/software/ralpha/
Cinema4D
https://www.maxon.net/ja/cinema-4d


神田駅周辺、紺屋町
53394632

沼津市にはLOD3がある
https://www.geospatial.jp/ckan/dataset/plateau-22203-numazu-shi-2021


調べ物とインポートを行なった。
データインポート２６０MBでバーごとフリーズ制御不能。
７０MBので一時間強時間がかかる。
Plateauメモで独立してまとめる必要性ありやも。




#7 2023/2/9
Plateau つづき
Cinemachine アセットを入れる。
Input System アセットを入れる。

LOD2
モデル→選択→マテリアル→テクスチャを抽出

プレファブをすべて展開で解除してから操作しないと変更が効かない


tran 道路情報をもっているが数メーターメッシュなので結合する必要がありそう

CombineMeshesを使ってメッシュを結合するサンプル
MeshクラスのCombineMeshes
https://ekulabo.com/unity-combine-meshes


#8 2023/2/10
Plateau つづき
サード・パーソンでプロジェクトを作成 → 地形  Environment を削除
Plateau の建物情報を追加
Dem 地面を追加して Mesh Colliderを追加して当たり判定

軽量化のテクニック
ライトのディレクショナルライト、ジェネラルをベイクド（焼き込んでしまう）
建物を選んでスタティックにしてしまう。(名前の横 静的)

サードパースン
カメラの方向性感度が悪い問題
PlayerArmature の PlayerInputのActionsにいるStartAssets Input Action Assetを開く
LookのDelta[Pointer] → Scale Vector2 のXの値を変えてやる 例 0.16 
ミニウインドを閉じることでセーブがはいるので閉じる

Lod2を表示しつつLod1のメッシュコライダーを利用することで建物への衝突判定。
Lod1のMesh Rendererのチェックを外して衝突領域の非表示

PlayerFollowCamera
CinemachineVirtualCamera
Body:
Camera Side:0.5で真ん中
Camera Distance:-1.05 でほぼFPS : 4 でFPS
Sholder Offset X:1 Y:0 Z:0 ど真ん中
	X:1 Y:1.6 Z:0  Camera Side:0.84 Camera Distance: 9 でValheim的FPS

Damping From Collijonをコリジョン 衝突時にスムーズなカメライージング
Damping Into Collijonをコリジョン が中間にあるときにスムーズなカメライージング
減衰：カメラがキャラクターからどれだけ置いて行かれるか



#9 2023/2/10
Unity × plateau 公式のガイドどおりにハンズオンしてみる


#10 2023/3/5
Plateau for UnityのSDKにさわったがうまく動かせなかった



#11 2023/3/23

3/20ごろにカメラ操作の機能を軽く実装。そのつづきから。

ウィンドウ＞レンダリング＞ライティング
ライティング設定ウィンドウ＞環境タグ＞その他の設定＞フォグ＞密度 0.0005



バードビューの設定をカメラの切り替えで対応
vcamera.transform.SetPositionAndRotation(new Vector3(0,0,0), Quaternion.Euler(0,0,0));
CinemachineFramingTransposer transposer = vcamera.GetCinemachineComponent<CinemachineFramingTransposer>();
transposer.ForceCameraPosition(new Vector3(0,0,0), Quaternion.Euler(0,0,0));
transposer.ForceCameraPosition(Vector3.zero, Quaternion.identity);
ここらへんが効けばよかったのだが、俯瞰にできなかった。

カメラルートを追加することでバードビューを実装。



#12 2023/3/25

UniversalRenderingExamples
Visual Effect Graph

などのプロジェクトも起動して、使えそうなところをマージしようとした。

Project Settings > Editor > Numbering Scheme > ゲームオブジェクトの命名規則
(1) から _1へ変更


画面に重ねたItemトリガーUIをつくろうとした。
Tabメニューの実装のまえにショートカットからマウスのトリガーをつくろうとした。

アイテムボックス内の並び替えをおこないたいが、
ただし、InputSystemが邪魔して、クリックがうまく拾えない。3rdParsonのEventSystemがいないところでやれば拾えるけど、それだと意味がないので、苦戦。

Laycasterでイベントを並び替え、
btn1.transform.SetSiblingIndex(2);
など。コードからは制御できる。
OffにしてEventSystemを切り替える必要あり？


#13 2023/3/29
マウスポインターの配置
https://fontawesome.com/search?p=2&o=r&f=brands

https://qiita.com/TakaoIto/items/86d997ebd9167bc122b6

2.赤丸で囲んだ歯車アイコンをクリック->AdvancedProjectSettingsを開く
4.PackageManagerの画面に戻り、左上の＋ボタンからAdd package from git URLを選択
com.unity.vectorgraphics

パッケージマネージャーvectorgraphicsをいれてfontawesomeのアイコンを使おうとしたが、そのままリソースにぶっこんでも表示されない。


VFX、VisualEffectGraph-Samples-12.1.4-rev1をいれたが、
パッケージマネージャーからインポートしたVisual Effect Graphにサンプルボタンがあり、
こちらから入れられる12.1.7のサンプルを追加。
C:\_99_kura\unity\Plateau3rdPerson\Assets\Resources\Prefabs
に
Bonfire
を追加。
instanceで追加できるようにした。
UnitVFXPrefab.cs


MainCameraに張り付いてしまった
UniversalAdditionalCameraData
が重複しているがコンポーネントを削除できない。
しかたないので、プレファブからオリジナルを追加。

マウスクリックで位置検出をおこなったが、あくまで画面上のポインターのいち。

ゲームオブジェクトないのどれをクリックしたかを
OnClickで拾いたい。次回課題。





#14 2023/3/30

todo
カメラが地面の下にもぐる

Bonfire
にrigibodyとcolliderを設定
colliderにPhysic Materialを設定


Assets > Create > Physic Material を選択します。次に、シーン内の Collider にプロジェクトビューから物理特性マテリアルをドラッグ
New Physic Material
火が弾性力を０にしても重ねると跳ねる
なぜだろう？

プレイヤーキャラでcubeなどを押せない。
PlayerArmature
に、rigibodyとcolliderを設定、回転してしまうので位置と回転を固定


RaycastでPlateauからもってきたlodの上にオブジェクトを追加したいが、vectorの値が変
hit.collider.gameObject.transform.position が結構とんでもない位置を返している。
親（LOD2）の位置がそもそもおかしい -3502.517 -26.75882 -51782.59
lod1_53392633_bldg_6677 が x軸方向に-90回転して表示しているので座標が合わない


#15 2023/4/2
4/1 github copilotをいれる。chatGPT APIをいれて試してみる。

Menu: Window > AI > Navigation にて Navigationパネル
地形はすべてStaticにする

Navigationタブ > Bake > Bake で、Navmeshが設定される


Navigation挙動がだいぶおかしい。
キャラ同士の衝突で経路探索（最初の自分の位置）がずれている？


#16 2023/4/5
NavMeshをさわる。坂道などの経路探索、経路探索というか、複数の障害物やエージェントとぶつかったりしたときの挙動がわからない。コード制御以前。

NavMesh Obstacle、
Off-mesh LinkのDrop-Down、Jump-Acrossリンクを検討。
Navigation ウィンドウ の Areas タブ コスト、エリアマスクなどの実装は見送り。


オブジェクトの自由追加から、ナブメッシュをコード側から制御できるようにして
経路探索をナブメッシュエージェントに行わせることは可能か？

ex.壁を実行後、動的に作成して、それをエージェント積んだオブジェクトが迂回したい。




アボイダンスを表示してみる

NavMesh
シーン 加算ロード（非推奨？）
DontDestroyOnLoadにインスタンスをつっこんだまま次のシーンをロードする
シーン間の移動はNavMeshLinkでおこなう


NavMeshのコードによる動的生成は？
2017年情報
【Unite 2017 Tokyo】Navmesh完全マスターへの道
https://www.youtube.com/watch?v=3KF3sqCZVXE

NavMeshBuilder, NavMesgData, NavMeshLinkinstance, Default Execution Order
NavMeshSourceTag
NavMeshSurface
NavMeshModifier(他のリジッドボディを持ったものをNavMeshに含めない)


角速度と加速度をあげておくと角をスムーズに曲がれる。速度は低く。


RigidbodyとNavMeshの連携（オルタナティブ←本当？今でも？
NavMeshで動かす場合
IsKinematicはtrue
復帰時にNavMesh.SamplePositionで直近のNavMesh座標を取得
agent.WarpでAgentを移動させる

Rigidbodyで動かす場合
updatePositionとupdateRotationはfalse
agent.isStoppedはtrue


ナブメッシュビルドコンポーネント


#17 2023/4/8

衝突でNav Meshの挙動がおかしいとき。
衝突する側のNPC双方にNav Mesh Obstacleをつけてやると経路計算のときに無理に通ろうとしなくなるのでよい。


オブジェクトを静的に
ステージのオブジェクトをNavigation Staticに
離れてる足場があるならOff Mesh Link Generation も選択



todo 目的地到達でdirectionをoffにする


#18 2023/4/11
UnitNPCact.cs
OnCollisionEnter
OnTriggerEnter

などでイベント同士の接触イベントを拾おうとしたが、
接触のコラダーとrigibodyなどのシェイプが違うからか、
なかなか接触判定を検出しにくい。
物理演算が働いて飛ぶことがあるのに、OnCollisionが発生しないなど。


#19 2023/4/14
Unityのエディタバージョンを2022.2.1f1に変更（元2021.3.7f1）
UnitSpawnをつくりはじめる。
プルダウンから選択してゴミオブジェクトをばらまくスポナー
ゴミを回収するルンバ、シリンダーをつくる予定。

TextMeshProいまだに漢字問題をクリアしていない
NavMeshのベイクがみあたらない。


#20 2023/4/18

will check 
EnemyLitters をtagに手動で追加しておく必要がある

EnemyLitterと、EnemyEnum、EnemyStatusなどをざっくり作成。
ごみを散らかすシリンダーを作成。


次回、リッターがゴミをチラかしながら歩き回る。

ゴミを片付けるルンバを作成。


#21 2023/4/22

TowerSweeperを作ろうとしたのだけど処理が重なるので、
共通用の関数、名前空間CommonsUtility、
便利関数郡GameObjectTreat
GlobalConst、GameConfigのシングルトンやらを作成ちょいと苦戦。


#22 2023/4/23

Capsule Colliderなどの高さと向きの関係がわからない。
高さを同じにして向きをYやX、ZとYで同じ領域を拡大しているようには見えない。

OnTriggerEnterの使い方


動的に追加したゲームオブジェクトのOnTriggerEnterの設定の方法がわからないので、
プレファブなどであらかじめ設定しておく必要がある
視界コライダー、衝突コライダーなどをすべてスクリプト側から制御するのは大変そう。
というか、ちょっとやったけどできなかった。


#23 2023/4/26

コライダーにシリンダーがないので厄介

コードからの追加が難しかったので、OnTriggerEnterを載せたプレファブを作ることで対応。
オントリガーの視界に入ったオブジェクトの色を変えるテストスクリプトを作成。


#24 2023/5/10
ゴミを認識させて、色を替えるやつを少しだけ拡張
接触していないプレファブも複数動くと全部が同期してしまっているので対応が必要。



#25 2023/5/30
リハビリ、InputSystemとFreeLookCameraをUnitSpawnに導入。
少しだけカメラを動かせるようにした。



#26 2023/6/6
Jammoのプレファブをインストール、マテリアルが読み込めずピンクになってしまったので、
Window > Rendering > Render Pipeline Converter
をすべてチェックしてImotialize and Conberters
時間がかかりすぎているので
Material Upgrade
だけのチェックで再実行
ごみ撒き敵をシリンダーからプレファブに変更、もろもろ
次回は、ゴミ片付けAIの動作つくりこみ



#27 2023/6/22
TowerSweeperを
プレファブ呼びからスクリプト経由のインスタンス化へ
DestroyAllイベントの試作
OnTriggerEnterで苦戦再び

次回は、OnTriggerでDestroyを動かせるように。（自分の、ならびにガベージキューブ）


#28 2023/6/29

クラスを呼び出してプレファブを貼っていたが、オントリガーイベントが子供のプレファブについてしまうので、呼び出し時にプレファブを追加して、そのプレファブにクラスをアタッチすることにした。

一つのゲームオブジェクトに２つのトリガーイベントがある場合区別できるか？
ごみオブジェクト発見時と、接触時をそれぞれ別のトリガーで認知させたかった。
同じgameobjectに貼り付けたコライダーだと区別できなさそうなので、要検討。
→ 子供のオブジェクトにその処理用のクラスを作る？

ちょっと再起でエージェントが増えそうなので、設計検討。

次回は、ごみ掃除ロボットが自動で動いてちかくのゴミ掃除をするところを作成する。



#29 2023/6/30

スイーパーボットの行動パターン作成
近くのゴミオブジェクトを見つけて、近寄って、片付けるところまで


#30 2023/7/6
OnTriggerStay がgndと設置している間呼ばれ続ける問題。なんとかならんか？
this.transform.rotation.eulerAngles.y
オイラー角で比較せねばならぬところを
transform.rotation.y
で比較していたため、角度の計算がうまくできていなかった。rotationは-1～1を返す。
destinationの初期位置、yだけthis.transform.positionとずれている。なぜか？


次回、
Y軸方向に回転しているので修正。destination Y?
ハブを中心に完璧に掃除するモード、離れ過ぎたら戻ってくる機能

#31 2023/7/12
Quaternionに苦戦。
LookRotationに苦戦。
destinationでy軸で位相がうまれてて、destinationセット時にキャラクターがひっくり返ってたので調整。

UI Toolkitを使ってみる・・・
あー、コンフィグ画面用？
https://forpro.unity3d.jp/unity_pro_tips/2022/04/21/3629/
スイーパーにHPをつけて、バッテリーが切れたらDeckに戻る処理を実装。
Deckから離れすぎないようになった。
次回はゴミにHPをつけるか、リファクタリング。



#32 2023/7/13
点数計算のクラスを追加。ゴミのサイズによって点数を変化させる。
細かな部分の修正。文字列直値をEnum参照に部分変更をテスト。



2023/7/22（予備調査）
2023/7/23（予備調査）
#33 2023/7/25
[ひとりハンズオン]PLATEAU×HDRPをなぞってみる

すぐに試せるらしいのでやってみることにしました・・・が？

PLATEAU × HDRP すぐに試せる高品質レンダリングテクニック
https://www.youtube.com/watch?v=onGtk0aDKA4

苦戦内容とかは随時更新していきます。

インポートしたパッケージ
・Plateau SDK for Unity 1.1.6
・FBX Exporter 4.2.1



これはおもしろそうって思い、冒頭のさらっと紹介されていたFBXへの変換をFBX Exporterを使ってやったところおおハマりました。マテリアル、サーフェス入力のベースマップ欠落が抜けて戻せませんでした。
Plateau SDKからインポート→Plateau SDKの機能でエクスポート、fbx、テクスチャにチェックを入れてやらないとだめみたい。

m_Materials.Array.data[0]

国土地理院 地理院タイル タイル座標確認ページ
https://maps.gsi.go.jp/development/tileCoordCheck.html#5/35.362/138.731

別プロジェクトを作成してHDRPの動作を確認した。


#34 2023/7/28

PLATEAU-SDK-Toolkits-for-Unity


[パッケージマネージャーウィンドウ] パッケージ追加のエラー: file:C:/_99_kura/unity/PLATEAU-SDK-Toolkits-for-Unity-0.1.0.tgz
Unable to add package [file:C:/_99_kura/unity/PLATEAU-SDK-Toolkits-for-Unity-0.1.0.tgz]:
  Package com.unity.plateautoolkit@file:C:\_99_kura\unity\PLATEAU-SDK-Toolkits-for-Unity-0.1.0.tgz has invalid dependencies or related test packages:
    com.synesthesias.plateau-unity-sdk (dependency): Package [com.synesthesias.plateau-unity-sdk@1.0.0] cannot be found
UnityEditor.EditorApplication:Internal_CallUpdateFunctions ()


環境変数PathにC:\Program Files2\Git\cmd
を追加。Unity再起動


PLATEAU-SDK-Toolkits-for-Unity-0.1.0.tgz
いれようとして、com.synesthesias.plateau-unity-sdk (dependency)
あれーはいってるのになー、ってなって、迷子になってる。
んーんーー


[パッケージマネージャーウィンドウ] パッケージ追加のエラー: https://github.com/Project-PLATEAU/PLATEAU-SDK-Toolkits-for-Unity.git
Unable to add package [https://github.com/Project-PLATEAU/PLATEAU-SDK-Toolkits-for-Unity.git]:
  [https://github.com/Project-PLATEAU/PLATEAU-SDK-Toolkits-for-Unity.git] does not point to a valid package. No package manifest was found.
UnityEditor.EditorApplication:Internal_CallUpdateFunctions ()


#35 2023/7/30
自由位置にタワー召喚
情報ウィンドウを作成など

マウスポインター用の
ポストプロセス、Bloomなどで発光処理（あまりうまく表現できず）、下向きの矢印にでもしようとおもったけどこちらもうまきできず。

Unity ２回落ちる。

東京タワー周辺の起伏に富んだ土地を地面がわりに。
掃除ロボットなど空中に浮かんだまま動かなくなる→ 対策必要。


#36 2023/8/3 

リッターとスイーパーを起伏がついた土地のナブメッシュに対応できるようにした。
スポーンマーカーを起点にユニットを設置できるようにした。
ナブメシュ、段差が超えられなくてスタックしたときの処理（TODO？）

次回、ユニットへのレイキャストで情報ウインドウを表示。



#37 2023/8/4
情報ウインドウの表示UIをおおわくで作成。
表示用の構造体を作成。
UI系の作成。

次回、クリックしたUnitの構造体取得から情報表示。


#38 2023/8/5
UI ウインドウをドラッグで移動できるようにした。
EventTriggerのイベントリスナーでやろうと思ったがうまくいかず、単機能でクラス化をした。
課題。端をクリックしてもドラッグ開始で中心に来てしまう。

, IDragHandler

	public void OnDrag(PointerEventData eventData)
	{
		Vector3 TargetPos = Camera.main.ScreenToWorldPoint (eventData.position);
		TargetPos.z = 0;
		transform.position = TargetPos;
	}

https://docs.unity3d.com/ja/2018.4/ScriptReference/EventSystems.IDragHandler.html


#39 2023/8/6
アイテムメニューの作成
画像のTexture TypeをSprite (2D and UI)に変更

UIItemのスクリーンスペースカメラのところ、
レンダーカメラにmainが設定されていたためにややこしいことになっていた。

UIメニューの並び替え、こんな単純なMarkLayoutForRebuildとGetSiblingIndexの変更に二時間半かかった。敗因はcanvasのレンダーカメラが設定されていたため位置ずれしてたのが原因。



#40 2023/8/8
アイテムリスト、ボックスのTABで閉じ開きするトグルを作成。
item_holderのプレファブを削除してしまい戻せず泣く。
ボタンの押下時の色変更がiconイメージを同じコンポーネントにImageを持ってしまうと反映されず、子にした。
ankerpositionやGetSiblingIndexなどで苦戦。



#41 2023/8/9
クリエイトメニューを作成。TABで開くとじできるように。
作成ゲージ表示を作成。
小画面を先に閉じてしまうとTABキーでセットアクティブできないので、parentObject経由でfindしてやるとsetActiveがfalseになっていてもアクセスできるようだ。


#42 2023/8/11
Itemリスト作成、構造体で苦戦。
https://fontawesome.com/icons/virus-covid?f=classic&s=solid
svgアイコン導入
アイコンのインスペクターでGeberated Asset Typeを
Textyred Sprite に変更で表示できるようになる。

アイテムの構造体をもってアイテムクリエーションのページ送りができるように。
modelの下にデータ初期設定用の構造体をおくことにした。



#43 2023/8/13
アイテムを作成でアイテムリストに追加できるようにした。
同じアイテムはスタックするようにした。

ページネイトなどのボタン処理、interactableがfalseのときにクリックすると、trueに戻ってからもクリックできない。（要動作確認）


#44 2023/8/13
UnitBtnInteractable ボタン処理の確認。イベントリスナーのところが原因っぽかった。
GetPersistentEventCount()で取れる値がAddListenerを含まないためイベント付与がされない。

ImageのRaycastTargetのチェック

ツールチップの実装
OnMouseOver()、OnMouseExit()は3Dオブジェクトなどでしか拾わないため、
OnPointerEnter、OnPointerExitを画像の上に表示することで確認。

ボタンの上に重なっているイメージのレイキャストターゲットが障害か？


ScreenPointToLocalPointInRectangleでポインターの位置がずれる問題を解決。
Input.mousePositionを使っているので他の入力操作系に対応できていない。

Item_holderのItem_iconのほうのtooltipがうまくうごかない。上になにかかぶさっているかも？

debug_pointer(); poのイメージのレイキャストターゲットがONになっているとOnPointerEnterが作動しない。


Unityマウスポインターを拾うのがばかみたいに大変。
Unityのposition、localposition、anchoredPositionとか複数あって、
これにtransformのとRectTransformがあって、カメラのスケールの問題でScreenToWorldPointがあって、

UI系上の位置だとcanvasみて、ScreenPointToLocalPointInRectangleで再調整しなければいけない。
あげくレイキャストターゲット。ほんと無理。

次回、Item_holderでのMouseOverTipsCtrl動作化。


#45 2023/8/14
MouseOverのtip Item_holderでもレイキャストターゲットで、ImageとTextを外してやることで再現した。
位置が少しおかしいけどご愛嬌。
スコア表示用のUIと時間表示を実装。
floatじゃ不安があるからとTime.timeAsDoubleがよさそうだったので使ってみたのだけど、これがなんの時間かわからない。
EscメニューにTime.timeScaleで一時停止を実装。



#46 2023/8/16
アプリケーションのバージョン取得のためにPostProcessBuild[1]を移植。
配置をEditor下にしなかったので苦戦。


#47 2023/8/19
ゲーム開始画面を作成。動画やロゴはありあわせ。iconはadobeのAIロゴメーカで。1時間で終わるようないようを4時間やった。えらい。
ビデオプレイヤー video Clip→mp4、レンダーモード→カメラ ニアかファー、カメラ→メインカメラ
Rect Mask 2Dでぼかし処理。
constにディクショナリー、readonlyでstaticで書いてやればいける。



#48 2023/8/20
チュートリアル画面を作成。プレイヤー動作、UI操作を同じ画面に配置。
インプットシステムが別々だと動かないので別クラスにしてマージ。
ThirdPersonControllerをInputController、PlayerInputsで制御するように変更。



#49 2023/8/21
ステージから落ちたときの処理を書いてたんだけど、
OnTriggerEnter 入ったときと出ていったときでイベントが二回発生する。


Unityイベント発火のタイミングとかpositionの処理が読めないので何度も何度も実行して違うなーってなる。
ステージから落ちたオブジェクトを処理するための奈落受け皿をつくったんだけど、OnTriggerEnterが２回走っててなんでだろう？
イベントトリガーの厚みかとおもったけど、落ちたオブジェクト（PlayerArmature）が足元にもコライダー持ってた・・・。なんだ罠か。


OnApplicationFocusでマウスカーソルの制御をしたかったが挙動があやしい。


本日の進捗。ステージから落ちたときの処理を書いてたんだけど、StarterAssetsのPlayer Inputつけてるとうまく移動ができない。なんでこんなに難しいんだ。丸いオブジェクトみたいに下に落ちたら上から落ちてくるようにしたいだけなんだが・・・。


#50 2023/8/21
Player Inputをつけてても、動くようになんとかした。_controller.enabled = false;が原因。
地震イベントを実装。P波は動くが、S波はPhysic Materialを地面につけてみたがうまく動かず。
縦波も振幅がでかすぎると床抜けする。


#51 2023/8/24
クリックイベント。raycast hitの値がうまく拾えず苦戦。
hit.collider.gameObject.transform.localPosition

plateau苦戦
raycast hit、建物オブジェクトのメッシュが中心座標になく、その分ずれる。
建物をクリックしてもオブジェクトの中心座標を返してくる。
どうすれば建物の座標が拾えるか？
.mesh.uvや.mesh.verticeはNot allowed to access

内包されているメッシュの座標は個別に拾えない。


#52 2023/8/24


#53 2023/9/27
Plateau SDK を 2.0.2ALPHAをいれてみる。
福島をインポート、GML情報がでてくるかとおもったがでてこなかった。


#54 2023/10/07
Plateau SDKがエラー出していたので、古いSDK削除しながら再起動。
レイアウトファイルがないとエラーが出て起動できず、工場出荷時ボタンも効かず。
CurrentLayout-default.dwltをLibraryフォルダに配置するが効かず。
Libraryフォルダを削除→再起動成功


ユーティリティにPlateauInfo.csを作成 Plateau SDKのSlackから情報を取得。
SDKのバージョンを2.0に上げたことで、Meshrenderにもアクセスできるようになったし、gmlの情報もアタッチされるようになったのでだいぶ幅が広がった。ずっと問題だったローカルポジションとmeshの位置が違う問題もこれで解決？



#55 2023/10/9

メッシュレンダーから選択LODの中心座標、拡張範囲の四隅を表示。ぎりぎり際の位置は現段階では難しそう。
PLATEAU.CityInfo.CityObjectListのList、key,valueの、valueでそのまま返してくれればいいのに、pair.Value.StringValueに居た。探すの苦労した。

attrMap.DebugString(i)でインデックス番号を指定しなきゃならない点も探すのに苦労した点。
foreachでpair.Value.DebugString(0)なら出るのだけど流石にDebugStringではなくて他にあるだろと。


#56 2023/10/11

3D都市モデル標準製品仕様書
https://www.mlit.go.jp/plateaudocument/#toc8

使えそうなgml情報

bldg:measuredheight, value: 9.3
計測により取得した建築物の地上の最低点から最高点までの高さ。単位はm（uom=”m”）とする。

bldg:usage, value: 402
用途の区分
ファイルURL
https://www.geospatial.jp/iur/codelists/3.0/Building_usage.xml
コード	説明
401	業務施設
402	商業施設
403	宿泊施設
404	商業系複合施設
411	住宅
412	共同住宅
413	店舗等併用住宅
414	店舗等併用共同住宅
415	作業所併用住宅
421	官公庁施設
422	文教厚生施設
431	運輸倉庫施設
441	工場
451	農林漁業用施設
452	供給処理施設
453	防衛施設
454	その他
461	不明


uro:buildingDisasterRiskAttribute

uro:depth, value: 0.03
構造物が設置された位置の水深。単位はmとする。

uro:scale, value: L2（想定最大規模）
想定最大規模降雨あるいは計画規模降雨のいずれにより作成されたかの区分。


uro:buildingID
建築物に付与される固有の識別子
建物が法的な建物とプロパティのデータベースに登録されると、恒久的な識別子に変更される。

uro:duration
浸水が継続する時間。単位は時間（uom=”hour”）とする。

uro:city, value: 群馬県桐生市
uro:prefecture, value: 群馬県
uro:surveyYear, value: 2016


XMLからデータを変換して取得するのに戸惑った。



#57 2023/10/12 いがいと苦戦したGIS一段落
raycastがUIを貫通してしまう問題
あいかわらずUIつくりがめんどくさい。
建物情報を画面に表示できるようにした。


#58 2023/10/22
建物の面積や建物の高さなどから床面積を計算して統計値から住まう人数などを算定した。でも、床面積が小さすぎて０人になる建物とかがある。それに６平米しかない文教施設とかなんなのだろうか？計算が間違えている？土地勘のある土地でやらないとだめなのかも。

２０平米ぎりぎりだったら１人住まいにしてもいいのかもしれない。



#59 2023/10/25
建物マテリアルの変更をできるようにした。
GMLの表示情報を絞った。
表示の見出しキャプションを無理くり日本語表示＋マルチ言語対応できるように後で差し替え可能な様式にした。
次回は他のイベントなどと連携して、スコアやゲームイベントの作成など


-- 11/3 --
Zoom開催 Plateau のイベントで５分LT


#60 2023/11/15

Storageに使わないシーンを移動

TODO:一回目のTABキー押下でメニューがでてこない→最初をtrueにすることで直した

沼津市のデータでテストをするには重すぎる。
プレイヤーキャラクターをクリックすると、マテリアル変更かPlateauのアクセスのところあたりでアロケーションエラーでUnityが落ちる。触らないようにタグで回避したが他の部分が動かなくなりそう。
別のシーンでUIプレファブを入れて動くようにしたいが、レイヤー順序などがかわってしまっていてそのまま動かせない。調整が必要。

タグにPlateauObjectを使うとdemのGroundが外れるので注意。


沼津重すぎワロタ


#61 2023/11/25
プレファブの階層構造かえたストラクチャーが拾えなくてどういうこと？？ってUnity再起動したらでてきた。。。

今日はここまで
カメラの動きがおかしかったのでいろいろいじった。適当につくったもののつけを払う。コード上の値とUnitのインスペクターで表示されるデータが違うのに再びはまる。
Tabメニューの作りを少し手直し。こちらもプレファブの構造もちかた変えたらUnityバグり(キャッシュ？)。再起動したら読み込みなおされた。

次回、右クリックやらボディをクリックするとアロケーションで落ちるので修正。



#62 2023/11/26

右クリック、左っクリックイベントならびに奈落などを再調整。
相変わらずアンカーポジションとかローカルポジションがわからない。
demの少し下に奈落をつくりたいがレンダリングポジションの関係でうまく配置できず。
困ってる。
また、クリック時によくわからないイベントが発生しているようでキューブが沢山出る。
奈落にキューブが落ちている？


#63 2023/11/28 AM1

カメラの調整と奈落の調整をおこなった。コードで制御すると動作がわかりにくい。動かさないとわからない感じ。どうしよう。

火を散らばらせるエフェクトを実験のために配置。あとで消す。


#64 2023/11/29 朝
プレファブのフォルダ整理などを少し。
虫眼鏡機能をアイテムホルダーから呼べるようにパスを作った。
次回、虫眼鏡機能などのクラス化。（現在クリックの下に関数でいる



# 裏作業
ビルド環境をシーンを外しながら調整。
SSDを0MBになるまで食いつぶし、ビルドできない。
1TBのWDのSSDを買って積む。
ずっとビジーになる。
UnitSpawnを外すと大丈夫。
UnitSpawnがシーンも開けない。
開けない原因、アセットストアから入れたJammo-Characterのプレファブ読み込んでるのが原因だった。
navmeshなども疑ったが、Jammo-CharacterのフォルダをEditorの下に移動していたことが原因（多分



#65 2023/12/3
YamlDotNet for Unityを入れて、yamlファイルを参照できるようにした。大苦戦。using YamlDotNetを認識してくれなかったが、Unity再起動で治った。slnファイルかcsprojあたりが多分原因。読み込めるようになったので今日はここまで。


#66 2023/12/6

UINoticeを作成。左クリックで消える。
StagingYamlCtrl
LoadYamlDataからイベント呼び出しの構造だけつくる。EventLoaderにストック。
GameTimerCtrlをシングルトンに



#67 2023/12/10
マテリアルをリスト化した場合、自分で明示的破棄をしないとリークするらしい。でも挙動中は破棄できない。
建物地震イベントなどの呼び出しと、建物破壊イベントなどを実装した。


#68 2023/12/12
壊れたビルの再建機能を実装。得点処理BITを実装。
次回建物から演算力CLKを取得できる処理を実装して、ワークユニットを配置できるようにする。


ユニット作成でBITが減るように。


#69 2023/12/13

点数管理、BITとCLKを実装
アイテム選択時の地べた選択カーソルの表示

// EventSystem.current.currentSelectedGameObject が 一個前の選択されているオブジェクトが入ってきているので、
// マウス押下時ではなく、リリース時に発火するように変更。
// Assets/Editor/package/InputSystem/StarterAssets.inputactions


ワークユニットを呼び出し、点数計算をして、画面上に配置できるようにした。ただしいまのところ全部キューブ


#70 2023/12/15

理由はわからないが、なぶめっしゅの挙動
リアッタチしてあげないと動かないのでコード側で制御

ユニットを作成して画面上から配置できるようにした。

Award用のパワポ作成



#71 2023/12/27

ナブメッシュのエージェントタイプの高さが地面からのサーフェスの高さに影響している。

NavMeshSurfaceのAgent Typeを高さのあるものにしないとサーフェイスをベイクしたときにできる範囲作成がおかしい。
しかし、高さのあるものにすると地面からその高さ分離れた位置にサーフェイスが作成されてしまい、isOnNavMeshに居ないことになる。



#72 2024/2/1
金沢兼六園でチュートリアルマップを作成
Plateau SDKを2.3.0から2.3.2にアップデート
PLATEAU-SDK-Toolkits-for-Unity を導入
ガベージの大量召喚版などを作成


#73 2024/2/4
TAB メニューのカーソルの挙動変更
大量にゴミを召喚すると、奈落に落ちているオブジェクトがある
ゲーム内のUIがカーソル操作だけで動かない
InitializeItemListで設定する作成できるユニットをyamlからの呼び出しに変更
やりたい書き方ができずしんどみ。Yamlからの動的クラス読み込みにしたかったが、変数の関係でできずアホみたいな書き方になった。


#74 2024/2/11

コリジョン抜けの対応を力づくでおこなった。
次回はナブメッシュの対応を力づくで。

奈落抜けして落下しつづけているオブジェクトがある。適宣削除。
Sweeper たどり着けないゴミは無視するorウロウロする
ビルドモードのときカメラが旋回してしまう


#75 2024/2/14
CinemachineVirtualCameraで、
カメラに角速度がついたままカメラ制御を離してしまった場合、どうやってとめるのか？
tabメニューを開いてるモードを作って移動、視線制御をできないようにした。
コリジョン抜けした対策の奈落でもすべてを救済できないのでさらに奈落を追加したが、そもそも挙動がおかしい。奈落を管理する地獄コントロールをつくったが、見送り。
奈落を２つ重ねる。だが、また確認のこと。
GetClosestPointOnBounds思い通りの挙動になっていない。


#76 2024/2/15
プレイヤーキャラクターのCan PushフラグをONに
奈落の持ち上げ、再修正
移動最中にTABメニューを開くとあるき続ける→_input.MoveInput(Vector2.zero);で対応。

次回修正
スイーパーアルゴリズム
クリエイトメニュー画面、一度目のクリックで動作しない


yaml 説明書き表示
チュートリアル進行


#77 2024/2/16

 _NavMeshAgent.pathStatus がたどり着けないオブジェクトに対しても PathComplete を返している。
NavMeshAgent.hasPathも True
時間でたどり着けない場合IgnorListに追加することで力づく解決。もうだめだ。



#78 2024/3/1
マウスオーバーで表示されるtooltipがtabでアクティブ切り替えたとき消えないので、UIToolTips TAGの追加および、TAGの削除をTabMenuCtrl側で

ターゲットの探索の挙動があやしすぎる
post-process のBloomうまくできてない

#79 2024/3/2
照明効果がうまくできなかったので新しいプロジェクトでもテストをするなど
プロジェクト設定＞グラフィックス＞スクリタブルレンダーパイプラインで読み込みのURP設定を指定

直下にいたので他のURPの設定にならってSettingsに移動。
UniversalRenderPipelineAsset
ライティングの項目の右側三点リーダーからすべての項目を表示
「レンダリングレイヤーを使用」にチェック
これにチェックをいれるとライトオブジェクトのLightの項目にライトリングレイヤーの選択ができるようになる

カメラのレンダリング＞ポストプロセスを使用にチェック

カメラにポストプロセスレイヤーを追加



IntensityとThresholdの説明が揺れている
Post Processing
パッケージバージョン 3.2.2

https://docs.unity3d.com/ja/Packages/com.unity.render-pipelines.universal@14.0/manual/integration-with-post-processing.html

ユニバーサルレンダーパイプラインのポストプロセス

#80 2024/3/5
朝作業
post-processのbloomをオブジェクトに貼り付けるテスト
ライティング設定
オブジェクトに文字を表示するテスト
StandingSignbordオブジェクトを作成中
オブジェクト表面に表示する文字の表示の仕方すらわからない
fontsにNotoSansJP-VariableFont_wghtを追加
次回、看板の動作スクリプト


#81 2024/3/5
夜作業

スクリプトファイルの「インスペクタ -> Execution Order」

色々なプレファブにアタッチされたスクリプトがそのプレファブが読まれたとき実行されるが、
データファイル読み込みより後にイニシャライズ処理を実行したいみたいなやりかたがわからない。

Observable.NextFrame()
    .Subscribe(_ => Debug.Log("Next Frame"));
次のフレーム送りで順送りできる？

PlayerArmature/Geometry/Armature_Mesh
が落下し続けている

#82 2024/3/9
イベントローダーの順序をうまく制御できないのでStartとAwakeあたりの順番で力技予定

#83 2024/3/16
TMProのFontAssetCreatorの文字列設定が日本語ムズイのままだったので、常用漢字で再セット。
_IDLE_TIME_LIMIT

アイドルタイムに右下に表示する動作説明用のツールチップを作成


#84 2024/3/20

PowerCubeを作成
GameComponentInterfaces.cs
IItemStructProvider
    public ItemStruct ItemStruct => _item_struct;
の追加
CharacterStruct.cs
の追加

OnTriggerStayが発生しないことがある
目的地設定の Quaternion.LookRotation でvectorがzeroのときQuaternion.identity;をつかっていなかったのが原因？再現性微妙。

navメッシュの最短距離判定がおかしい。
すごく遠いオブジェクトを一番近いものと判定して拾いにいく。

次回パワーキューブの得点計算から





今日はここまで！


----
得点表示にも３桁区切り

int number = 9876543; // 変換前の数値
string str = "BIT";
string str = String.Format("{0:#,0}"+str , number);




シーン遷移時の処理
[PostProcessScene( 0 )]


つくば市 六角系都市、方向感覚を破壊する


オメガクラフト Omega Crafter面白いらしい。
https://store.steampowered.com/app/2262080/Omega_Crafter/?l=japanese


https://app.suno.ai/



タワーディフェンスゲーム
↓
厄災ウェーブ戦


ハンカモン

	

